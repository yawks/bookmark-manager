import React, { useState, useEffect, useMemo } from 'react';
import { icons } from 'lucide-react';
import { ArchiveIcon, CodeIcon, DrawingPinIcon, PersonIcon, VercelLogoIcon } from '@radix-ui/react-icons';
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '../ui/command';
import { Popover, PopoverContent, PopoverTrigger } from '../ui/popover';
import { Button } from '../ui/button';
import { Input } from '../ui/input';
import { t } from '../../lib/l10n';

// Cache for Simple Icons
let simpleIconsCache: SimpleIcon[] | null = null;
let simpleIconsPromise: Promise<SimpleIcon[]> | null = null;

const getSimpleIcons = (): Promise<SimpleIcon[]> => {
    if (simpleIconsCache) return Promise.resolve(simpleIconsCache);
    if (!simpleIconsPromise) {
        simpleIconsPromise = fetch('https://cdn.jsdelivr.net/npm/simple-icons@v11/_data/simple-icons.json')
            .then(res => res.json())
            .then((data: any) => {
                simpleIconsCache = data.icons;
                return data.icons;
            });
    }
    return simpleIconsPromise;
};

interface SimpleIcon {
    title: string;
    slug: string;
    hex: string;
    path: string;
}

// Legacy map from Collections.tsx
export const legacyIconMap: Record<string, React.ComponentType<{ className?: string }>> = {
    briefcase: ArchiveIcon,
    user: PersonIcon,
    figma: DrawingPinIcon,
    code: CodeIcon,
    'chef-hat': VercelLogoIcon,
};

// Emoji categories
interface EmojiCategory {
    name: string;
    emojis: string[];
}

const EMOJI_CATEGORIES: Record<string, EmojiCategory> = {
    smileys: {
        name: "Smileys & Emotion",
        emojis: ["üòÄ", "üòÉ", "üòÑ", "üòÅ", "üòÖ", "üòÇ", "ü§£", "üòä", "üòá", "üôÇ", "üôÉ", "üòâ", "üòå", "üòç", "ü•∞", "üòò", "üòó", "üòô", "üòö", "üòã", "üòõ", "üòù", "üòú", "ü§™", "ü§®", "üßê", "ü§ì", "üòé", "ü§©", "ü•≥", "üòè", "üòí", "üòû", "üòî", "üòü", "üòï", "üôÅ", "‚òπÔ∏è", "üò£", "üòñ", "üò´", "üò©", "ü•∫", "üò¢", "üò≠", "üò§", "üò†", "üò°", "ü§¨", "ü§Ø", "üò≥", "ü•µ", "ü•∂", "üò±", "üò®", "üò∞", "üò•", "üòì", "ü§ó", "ü§î", "ü§≠", "ü§´", "ü§•", "üò∂", "üòê", "üòë", "üò¨", "üôÑ", "üòØ", "üò¶", "üòß", "üòÆ", "üò≤", "ü•±", "üò¥", "ü§§", "üò™", "üòµ", "ü§ê", "ü•¥", "ü§¢", "ü§Æ", "ü§ß", "üò∑", "ü§í", "ü§ï", "ü§ë", "ü§†", "üí©", "üëª", "üíÄ", "‚ò†Ô∏è", "üëΩ", "üëæ", "ü§ñ", "üéÉ", "üò∫", "üò∏", "üòπ", "üòª", "üòº", "üòΩ", "üôÄ", "üòø", "üòæ"]
    },
    people: {
        name: "People & Body",
        emojis: ["üëã", "ü§ö", "üñê", "‚úã", "üññ", "üëå", "ü§å", "ü§è", "‚úåÔ∏è", "ü§û", "ü§ü", "ü§ò", "ü§ô", "üëà", "üëâ", "üëÜ", "üñï", "üëá", "‚òùÔ∏è", "üëç", "üëé", "‚úä", "üëä", "ü§õ", "ü§ú", "üëè", "üôå", "üëê", "ü§≤", "ü§ù", "üôè", "‚úçÔ∏è", "üíÖ", "ü§≥", "üí™", "ü¶æ", "ü¶ø", "ü¶µ", "ü¶∂", "üëÇ", "ü¶ª", "üëÉ", "üß†", "ü´Ä", "ü´Å", "ü¶∑", "ü¶¥", "üëÄ", "üëÅ", "üëÖ", "üëÑ", "üë∂", "üßí", "üë¶", "üëß", "üßë", "üë±", "üë®", "üßî", "üë©", "üßì", "üë¥", "üëµ", "üôç", "üôé", "üôÖ", "üôÜ", "üíÅ", "üôã", "üßè", "üôá", "ü§¶", "ü§∑", "üëÆ", "üïµ", "üíÇ", "üë∑", "ü§¥", "üë∏", "üë≥", "üë≤", "üßï", "ü§µ", "üë∞", "ü§∞", "ü§±", "üëº", "üéÖ", "ü§∂", "ü¶∏", "ü¶π", "üßô", "üßö", "üßõ", "üßú", "üßù", "üßû", "üßü", "üíÜ", "üíá", "üö∂", "üßç", "üßé", "üë®‚Äçü¶Ø", "üë©‚Äçü¶Ø", "üë®‚Äçü¶º", "üë©‚Äçü¶º", "üë®‚Äçü¶Ω", "üë©‚Äçü¶Ω", "üèÉ", "üíÉ", "üï∫", "üï¥", "üëØ", "üßñ", "üßó", "ü§∫", "üèá", "‚õ∑", "üèÇ", "üèå", "üèÑ", "üö£", "üèä", "‚õπ", "üèã", "üö¥", "üöµ", "ü§∏", "ü§º", "ü§Ω", "ü§æ", "ü§π", "üßò", "üõÄ", "üõå", "üë≠", "üë´", "üë¨", "üíè", "üíë", "üë™"]
    },
    animals: {
        name: "Animals & Nature",
        emojis: ["üê∂", "üê±", "üê≠", "üêπ", "üê∞", "ü¶ä", "üêª", "üêº", "üê®", "üêØ", "ü¶Å", "üêÆ", "üê∑", "üêΩ", "üê∏", "üêµ", "üôà", "üôâ", "üôä", "üêí", "üêî", "üêß", "üê¶", "üê§", "üê£", "üê•", "ü¶Ü", "ü¶Ö", "ü¶â", "ü¶á", "üê∫", "üêó", "üê¥", "ü¶Ñ", "üêù", "üêõ", "ü¶ã", "üêå", "üêû", "üêú", "ü¶ü", "ü¶ó", "üï∑", "üï∏", "ü¶Ç", "üê¢", "üêç", "ü¶é", "ü¶ñ", "ü¶ï", "üêô", "ü¶ë", "ü¶ê", "ü¶û", "ü¶Ä", "üê°", "üê†", "üêü", "üê¨", "üê≥", "üêã", "ü¶à", "üêä", "üêÖ", "üêÜ", "ü¶ì", "ü¶ç", "ü¶ß", "üêò", "ü¶õ", "ü¶è", "üê™", "üê´", "ü¶í", "ü¶ò", "üêÉ", "üêÇ", "üêÑ", "üêé", "üêñ", "üêè", "üêë", "ü¶ô", "üêê", "ü¶å", "üêï", "üê©", "ü¶Æ", "üêï‚Äçü¶∫", "üêà", "üêì", "ü¶É", "ü¶ö", "ü¶ú", "ü¶¢", "ü¶©", "üïä", "üêá", "ü¶ù", "ü¶®", "ü¶°", "ü¶¶", "ü¶•", "üêÅ", "üêÄ", "üêø", "ü¶î", "üêæ", "üêâ", "üê≤", "üåµ", "üéÑ", "üå≤", "üå≥", "üå¥", "üå±", "üåø", "‚òòÔ∏è", "üçÄ", "üéç", "üéã", "üçÉ", "üçÇ", "üçÅ", "üçÑ", "üêö", "üåæ", "üíê", "üå∑", "üåπ", "ü•Ä", "üå∫", "üå∏", "üåº", "üåª", "üåû", "üåù", "üåõ", "üåú", "üåö", "üåï", "üåñ", "üåó", "üåò", "üåë", "üåí", "üåì", "üåî", "üåô", "üåé", "üåç", "üåè", "ü™ê", "üí´", "‚≠ê", "üåü", "‚ú®", "‚ö°", "‚òÑÔ∏è", "üí•", "üî•", "üå™", "üåà", "‚òÄÔ∏è", "üå§", "‚õÖ", "üå•", "‚òÅÔ∏è", "üå¶", "üåß", "‚õà", "üå©", "üå®", "‚ùÑÔ∏è", "‚òÉÔ∏è", "‚õÑ", "üå¨", "üí®", "üíß", "üí¶", "‚òî", "‚òÇÔ∏è", "üåä", "üå´"]
    },
    food: {
        name: "Food & Drink",
        emojis: ["üçá", "üçà", "üçâ", "üçä", "üçã", "üçå", "üçç", "ü•≠", "üçé", "üçè", "üçê", "üçë", "üçí", "üçì", "ü´ê", "ü•ù", "üçÖ", "ü´í", "ü••", "ü•ë", "üçÜ", "ü•î", "ü•ï", "üåΩ", "üå∂", "ü´ë", "ü•í", "ü•¨", "ü•¶", "üßÑ", "üßÖ", "üçÑ", "ü•ú", "üå∞", "üçû", "ü•ê", "ü•ñ", "ü´ì", "ü•®", "ü•Ø", "ü•û", "üßá", "üßÄ", "üçñ", "üçó", "ü•©", "ü•ì", "üçî", "üçü", "üçï", "üå≠", "ü•™", "üåÆ", "üåØ", "ü´î", "ü•ô", "üßÜ", "ü•ö", "üç≥", "ü•ò", "üç≤", "ü´ï", "ü•£", "ü•ó", "üçø", "üßà", "üßÇ", "ü•´", "üç±", "üçò", "üçô", "üçö", "üçõ", "üçú", "üçù", "üç†", "üç¢", "üç£", "üç§", "üç•", "ü•Æ", "üç°", "ü•ü", "ü•†", "ü•°", "ü¶Ä", "ü¶û", "ü¶ê", "ü¶ë", "ü¶™", "üç¶", "üçß", "üç®", "üç©", "üç™", "üéÇ", "üç∞", "üßÅ", "ü•ß", "üç´", "üç¨", "üç≠", "üçÆ", "üçØ", "üçº", "ü•õ", "‚òï", "ü´ñ", "üçµ", "üç∂", "üçæ", "üç∑", "üç∏", "üçπ", "üç∫", "üçª", "ü•Ç", "ü•É", "ü•§", "üßã", "üßÉ", "üßâ", "üßä", "ü•¢", "üçΩ", "üç¥", "ü•Ñ", "üî™", "üè∫"]
    },
    activity: {
        name: "Activity",
        emojis: ["‚öΩ", "üèÄ", "üèà", "‚öæ", "ü•é", "üéæ", "üèê", "üèâ", "ü•è", "üé±", "ü™Ä", "üèì", "üè∏", "üèí", "üèë", "ü•ç", "üèè", "ü•Ö", "‚õ≥", "ü™Å", "üèπ", "üé£", "ü§ø", "ü•ä", "ü•ã", "üéΩ", "üõπ", "üõ∑", "‚õ∏", "ü•å", "üéø", "‚õ∑", "üèÇ", "ü™Ç", "üèãÔ∏è", "ü§º", "ü§∏", "ü§∫", "ü§æ", "üèåÔ∏è", "üèá", "üßò", "üèÑ", "üèä", "ü§Ω", "üö£", "üßó", "üöµ", "üö¥", "üèÜ", "ü•á", "ü•à", "ü•â", "üèÖ", "üéñ", "üèµ", "üéó", "üé´", "üéü", "üé™", "ü§π", "üé≠", "ü©∞", "üé®", "üé¨", "üé§", "üéß", "üéº", "üéπ", "ü•Å", "üé∑", "üé∫", "üé∏", "ü™ï", "üéª", "üé≤", "‚ôü", "üéØ", "üé≥", "üéÆ", "üé∞", "üß©"]
    },
    travel: {
        name: "Travel & Places",
        emojis: ["üöó", "üöï", "üöô", "üöå", "üöé", "üèé", "üöì", "üöë", "üöí", "üöê", "üõª", "üöö", "üöõ", "üöú", "ü¶Ø", "ü¶Ω", "ü¶º", "üõ¥", "üö≤", "üõµ", "üèç", "üõ∫", "üö®", "üöî", "üöç", "üöò", "üöñ", "üö°", "üö†", "üöü", "üöÉ", "üöã", "üöû", "üöù", "üöÑ", "üöÖ", "üöà", "üöÇ", "üöÜ", "üöá", "üöä", "üöâ", "‚úàÔ∏è", "üõ´", "üõ¨", "üõ©", "üí∫", "üõ∞", "üöÄ", "üõ∏", "üöÅ", "üõ∂", "‚õµ", "üö§", "üõ•", "üõ≥", "‚õ¥", "üö¢", "‚öì", "‚õΩ", "üöß", "üö¶", "üö•", "üöè", "üó∫", "üóø", "üóΩ", "üóº", "üè∞", "üèØ", "üèü", "üé°", "üé¢", "üé†", "‚õ≤", "‚õ±", "üèñ", "üèù", "üèú", "üåã", "‚õ∞", "üèî", "üóª", "üèï", "‚õ∫", "üõñ", "üè†", "üè°", "üèò", "üèö", "üèó", "üè≠", "üè¢", "üè¨", "üè£", "üè§", "üè•", "üè¶", "üè®", "üè™", "üè´", "üè©", "üíí", "üèõ", "‚õ™", "üïå", "üïç", "üõï", "üïã", "‚õ©", "üõ§", "üõ£", "üóæ", "üéë", "üèû", "üåÖ", "üåÑ", "üå†", "üéá", "üéÜ", "üåá", "üåÜ", "üèô", "üåÉ", "üåå", "üåâ", "üåÅ"]
    },
    objects: {
        name: "Objects",
        emojis: ["‚åö", "üì±", "üì≤", "üíª", "‚å®Ô∏è", "üñ•", "üñ®", "üñ±", "üñ≤", "üïπ", "üóú", "üíΩ", "üíæ", "üíø", "üìÄ", "üìº", "üì∑", "üì∏", "üìπ", "üé•", "üìΩ", "üéû", "üìû", "‚òéÔ∏è", "üìü", "üì†", "üì∫", "üìª", "üéô", "üéö", "üéõ", "üß≠", "‚è±", "‚è≤", "‚è∞", "üï∞", "‚åõ", "‚è≥", "üì°", "üîã", "üîå", "üí°", "üî¶", "üïØ", "ü™î", "üßØ", "üõ¢", "üí∏", "üíµ", "üí¥", "üí∂", "üí∑", "ü™ô", "üí∞", "üí≥", "üíé", "‚öñÔ∏è", "ü™ú", "üß∞", "ü™õ", "üîß", "üî®", "‚öí", "üõ†", "‚õè", "ü™ö", "üî©", "‚öôÔ∏è", "ü™§", "üß±", "‚õì", "üß≤", "üî´", "üí£", "üß®", "ü™ì", "üî™", "üó°", "‚öîÔ∏è", "üõ°", "üö¨", "‚ö∞Ô∏è", "ü™¶", "‚ö±Ô∏è", "üè∫", "üîÆ", "üìø", "üßø", "üíà", "‚öóÔ∏è", "üî≠", "üî¨", "üï≥", "ü©π", "ü©∫", "üíä", "üíâ", "ü©∏", "üß¨", "ü¶†", "üß´", "üß™", "üå°", "üßπ", "ü™†", "üß∫", "üßª", "üöΩ", "üö∞", "üöø", "üõÅ", "üõÄ", "üßº", "ü™í", "üßΩ", "üß¥", "üõé", "üîë", "üóù", "üö™", "ü™ë", "üõã", "üõè", "üõå", "üß∏", "ü™Ü", "üñº", "ü™û", "ü™ü", "üõç", "üõí", "üéÅ", "üéà", "üéè", "üéÄ", "ü™Ñ", "ü™Ö", "üéä", "üéâ", "üéé", "üèÆ", "üéê", "üßß", "‚úâÔ∏è", "üì©", "üì®", "üìß", "üíå", "üì•", "üì§", "üì¶", "üè∑", "ü™ß", "üì™", "üì´", "üì¨", "üì≠", "üìÆ", "üìØ", "üìú", "üìÉ", "üìÑ", "üìë", "üßæ", "üìä", "üìà", "üìâ", "üóí", "üóì", "üìÜ", "üìÖ", "üóë", "üìá", "üóÉ", "üó≥", "üóÑ", "üìã", "üìÅ", "üìÇ", "üóÇ", "üóû", "üì∞", "üìì", "üìî", "üìí", "üìï", "üìó", "üìò", "üìô", "üìö", "üìñ", "üîñ", "üß∑", "üîó", "üìé", "üñá", "üìê", "üìè", "üßÆ", "üìå", "üìç", "‚úÇÔ∏è", "üñä", "üñã", "‚úíÔ∏è", "üñå", "üñç", "üìù", "‚úèÔ∏è", "üîç", "üîé", "üîè", "üîê", "üîí", "üîì"]
    },
    symbols: {
        name: "Symbols",
        emojis: ["‚ù§Ô∏è", "üß°", "üíõ", "üíö", "üíô", "üíú", "üñ§", "ü§ç", "ü§é", "üíî", "‚ù£Ô∏è", "üíï", "üíû", "üíì", "üíó", "üíñ", "üíò", "üíù", "üíü", "‚òÆÔ∏è", "‚úùÔ∏è", "‚ò™Ô∏è", "üïâ", "‚ò∏Ô∏è", "‚ú°Ô∏è", "üîØ", "üïé", "‚òØÔ∏è", "‚ò¶Ô∏è", "üõê", "‚õé", "‚ôà", "‚ôâ", "‚ôä", "‚ôã", "‚ôå", "‚ôç", "‚ôé", "‚ôè", "‚ôê", "‚ôë", "‚ôí", "‚ôì", "üÜî", "‚öõÔ∏è", "üâë", "‚ò¢Ô∏è", "‚ò£Ô∏è", "üì¥", "üì≥", "üà∂", "üàö", "üà∏", "üà∫", "üà∑Ô∏è", "‚ú¥Ô∏è", "üÜö", "üíÆ", "üâê", "„äôÔ∏è", "„äóÔ∏è", "üà¥", "üàµ", "üàπ", "üà≤", "üÖ∞Ô∏è", "üÖ±Ô∏è", "üÜé", "üÜë", "üÖæÔ∏è", "üÜò", "‚ùå", "‚≠ï", "üõë", "‚õî", "üìõ", "üö´", "üíØ", "üí¢", "‚ô®Ô∏è", "üö∑", "üöØ", "üö≥", "üö±", "üîû", "üìµ", "üö≠", "‚ùó", "‚ùï", "‚ùì", "‚ùî", "‚ÄºÔ∏è", "‚ÅâÔ∏è", "üîÖ", "üîÜ", "„ÄΩÔ∏è", "‚ö†Ô∏è", "üö∏", "üî±", "‚öúÔ∏è", "üî∞", "‚ôªÔ∏è", "‚úÖ", "üàØ", "üíπ", "‚ùáÔ∏è", "‚ú≥Ô∏è", "‚ùé", "üåê", "üí†", "‚ìÇÔ∏è", "üåÄ", "üí§", "üèß", "üöæ", "‚ôø", "üÖøÔ∏è", "üõó", "üà≥", "üàÇÔ∏è", "üõÇ", "üõÉ", "üõÑ", "üõÖ", "üöπ", "üö∫", "üöº", "‚öß", "üöª", "üöÆ", "üé¶", "üì∂", "üàÅ", "üî£", "‚ÑπÔ∏è", "üî§", "üî°", "üî†", "üÜñ", "üÜó", "üÜô", "üÜí", "üÜï", "üÜì", "0Ô∏è‚É£", "1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£", "8Ô∏è‚É£", "9Ô∏è‚É£", "üîü", "üî¢", "#Ô∏è‚É£", "*Ô∏è‚É£", "‚èèÔ∏è", "‚ñ∂Ô∏è", "‚è∏", "‚èØ", "‚èπ", "‚è∫", "‚è≠", "‚èÆ", "‚è©", "‚è™", "‚è´", "‚è¨", "‚óÄÔ∏è", "üîº", "üîΩ", "‚û°Ô∏è", "‚¨ÖÔ∏è", "‚¨ÜÔ∏è", "‚¨áÔ∏è", "‚ÜóÔ∏è", "‚ÜòÔ∏è", "‚ÜôÔ∏è", "‚ÜñÔ∏è", "‚ÜïÔ∏è", "‚ÜîÔ∏è", "‚Ü™Ô∏è", "‚Ü©Ô∏è", "‚§¥Ô∏è", "‚§µÔ∏è", "üîÄ", "üîÅ", "üîÇ", "üîÑ", "üîÉ", "üéµ", "üé∂", "‚ûï", "‚ûñ", "‚ûó", "‚úñÔ∏è", "‚ôæ", "üí≤", "üí±", "‚Ñ¢Ô∏è", "¬©Ô∏è", "¬ÆÔ∏è", "„Ä∞Ô∏è", "‚û∞", "‚ûø", "üîö", "üîô", "üîõ", "üîù", "üîú", "‚úîÔ∏è", "‚òëÔ∏è", "üîò", "üî¥", "üü†", "üü°", "üü¢", "üîµ", "üü£", "‚ö´", "‚ö™", "üü§", "üî∫", "üîª", "üî∏", "üîπ", "üî∂", "üî∑", "üî≥", "üî≤", "‚ñ™Ô∏è", "‚ñ´Ô∏è", "‚óæ", "‚óΩ", "‚óºÔ∏è", "‚óªÔ∏è", "üü•", "üüß", "üü®", "üü©", "üü¶", "üü™", "‚¨õ", "‚¨ú", "üü´", "üîà", "üîá", "üîâ", "üîä", "üîî", "üîï", "üì£", "üì¢", "üí¨", "üí≠", "üóØ", "‚ô†Ô∏è", "‚ô£Ô∏è", "‚ô•Ô∏è", "‚ô¶Ô∏è", "üÉè", "üé¥", "üÄÑ", "üïê", "üïë", "üïí", "üïì", "üïî", "üïï", "üïñ", "üïó", "üïò", "üïô", "üïö", "üïõ", "üïú", "üïù", "üïû", "üïü", "üï†", "üï°", "üï¢", "üï£", "üï§", "üï•", "üï¶", "üïß"]
    },
    flags: {
        name: "Flags",
        emojis: ["üè≥Ô∏è", "üè¥", "üè¥‚Äç‚ò†Ô∏è", "üèÅ", "üö©", "üè≥Ô∏è‚Äçüåà", "üè≥Ô∏è‚Äç‚ößÔ∏è", "üá∫üá≥", "üá¶üá´", "üá¶üáΩ", "üá¶üá±", "üá©üáø", "üá¶üá∏", "üá¶üá©", "üá¶üá¥", "üá¶üáÆ", "üá¶üá∂", "üá¶üá¨", "üá¶üá∑", "üá¶üá≤", "üá¶üáº", "üá¶üá∫", "üá¶üáπ", "üá¶üáø", "üáßüá∏", "üáßüá≠", "üáßüá©", "üáßüáß", "üáßüáæ", "üáßüá™", "üáßüáø", "üáßüáØ", "üáßüá≤", "üáßüáπ", "üáßüá¥", "üáßüá¶", "üáßüáº", "üáßüá∑", "üáÆüá¥", "üáªüá¨", "üáßüá≥", "üáßüá¨", "üáßüá´", "üáßüáÆ", "üá∞üá≠", "üá®üá≤", "üá®üá¶", "üáÆüá®", "üá®üáª", "üáßüá∂", "üá∞üáæ", "üá®üá´", "üáπüá©", "üá®üá±", "üá®üá≥", "üá®üáΩ", "üá®üá®", "üá®üá¥", "üá∞üá≤", "üá®üá¨", "üá®üá©", "üá®üá∞", "üá®üá∑", "üá®üáÆ", "üá≠üá∑", "üá®üá∫", "üá®üáº", "üá®üáæ", "üá®üáø", "üá©üá∞", "üá©üáØ", "üá©üá≤", "üá©üá¥", "üá™üá®", "üá™üá¨", "üá∏üáª", "üá¨üá∂", "üá™üá∑", "üá™üá™", "üá∏üáø", "üá™üáπ", "üá™üá∫", "üá´üá∞", "üá´üá¥", "üá´üáØ", "üá´üáÆ", "üá´üá∑", "üá¨üá´", "üáµüá´", "üáπüá´", "üá¨üá¶", "üá¨üá≤", "üá¨üá™", "üá©üá™", "üá¨üá≠", "üá¨üáÆ", "üá¨üá∑", "üá¨üá±", "üá¨üá©", "üá¨üáµ", "üá¨üá∫", "üá¨üáπ", "üá¨üá¨", "üá¨üá≥", "üá¨üáº", "üá¨üáæ", "üá≠üáπ", "üá≠üá≥", "üá≠üá∞", "üá≠üá∫", "üáÆüá∏", "üáÆüá≥", "üáÆüá©", "üáÆüá∑", "üáÆüá∂", "üáÆüá™", "üáÆüá≤", "üáÆüá±", "üáÆüáπ", "üáØüá≤", "üáØüáµ", "üéå", "üáØüá™", "üáØüá¥", "üá∞üáø", "üá∞üá™", "üá∞üáÆ", "üáΩüá∞", "üá∞üáº", "üá∞üá¨", "üá±üá¶", "üá±üáª", "üá±üáß", "üá±üá∏", "üá±üá∑", "üá±üáæ", "üá±üáÆ", "üá±üáπ", "üá±üá∫", "üá≤üá¥", "üá≤üá¨", "üá≤üáº", "üá≤üáæ", "üá≤üáª", "üá≤üá±", "üá≤üáπ", "üá≤üá≠", "üá≤üá∂", "üá≤üá∑", "üá≤üá∫", "üáæüáπ", "üá≤üáΩ", "üá´üá≤", "üá≤üá©", "üá≤üá®", "üá≤üá≥", "üá≤üá™", "üá≤üá∏", "üá≤üá¶", "üá≤üáø", "üá≤üá≤", "üá≥üá¶", "üá≥üá∑", "üá≥üáµ", "üá≥üá±", "üá≥üá®", "üá≥üáø", "üá≥üáÆ", "üá≥üá™", "üá≥üá¨", "üá≥üá∫", "üá≥üá´", "üá∞üáµ", "üá≤üá∞", "üá≤üáµ", "üá≥üá¥", "üá¥üá≤", "üáµüá∞", "üáµüáº", "üáµüá∏", "üáµüá¶", "üáµüá¨", "üáµüáæ", "üáµüá™", "üáµüá≠", "üáµüá≥", "üáµüá±", "üáµüáπ", "üáµüá∑", "üá∂üá¶", "üá∑üá™", "üá∑üá¥", "üá∑üá∫", "üá∑üáº", "üáºüá∏", "üá∏üá≤", "üá∏üáπ", "üá∏üá¶", "üá∏üá≥", "üá∑üá∏", "üá∏üá®", "üá∏üá±", "üá∏üá¨", "üá∏üáΩ", "üá∏üá∞", "üá∏üáÆ", "üá¨üá∏", "üá∏üáß", "üá∏üá¥", "üáøüá¶", "üá∞üá∑", "üá∏üá∏", "üá™üá∏", "üá±üá∞", "üáßüá±", "üá∏üá≠", "üá∞üá≥", "üá±üá®", "üáµüá≤", "üáªüá®", "üá∏üá©", "üá∏üá∑", "üá∏üá™", "üá®üá≠", "üá∏üáæ", "üáπüáº", "üáπüáØ", "üáπüáø", "üáπüá≠", "üáπüá±", "üáπüá¨", "üáπüá∞", "üáπüá¥", "üáπüáπ", "üáπüá≥", "üáπüá∑", "üáπüá≤", "üáπüá®", "üáπüáª", "üáªüáÆ", "üá∫üá¨", "üá∫üá¶", "üá¶üá™", "üá¨üáß", "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", "üè¥Û†ÅßÛ†Å¢Û†Å≥Û†Å£Û†Å¥Û†Åø", "üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø", "üá∫üá∏", "üá∫üáæ", "üá∫üáø", "üáªüá∫", "üáªüá¶", "üáªüá™", "üáªüá≥", "üáºüá´", "üá™üá≠", "üáæüá™", "üáøüá≤", "üáøüáº"]
    }
};

export const RenderIcon = ({ icon, className }: { icon: string | null, className?: string }) => {
    if (!icon) return <VercelLogoIcon className={className} />;

    // URL
    if (icon.startsWith('http://') || icon.startsWith('https://')) {
        return <img src={icon} alt="Collection icon" className={`object-contain ${className}`} />;
    }

    // Legacy
    if (legacyIconMap[icon]) {
        const Icon = legacyIconMap[icon];
        return <Icon className={className} />;
    }

    // Emoji
    if (icon.startsWith('emoji:')) {
        return <span className={className}>{icon.replace('emoji:', '')}</span>;
    }

    // Lucide
    if (icon.startsWith('lucide:')) {
        const iconName = icon.replace('lucide:', '');
        const Icon = (icons as any)[iconName];
        if (Icon) return <Icon className={className} />;
    }

    // Simple Icons
    if (icon.startsWith('simple-icons:')) {
        return <SimpleIconRenderer slug={icon.replace('simple-icons:', '')} className={className} />;
    }

    // Fallback to Lucide if it matches a name directly (backward compat or user typed manual)
    if ((icons as any)[icon]) {
        const Icon = (icons as any)[icon];
        return <Icon className={className} />;
    }

    return <VercelLogoIcon className={className} />;
};

const SimpleIconRenderer = ({ slug, className }: { slug: string, className?: string }) => {
    const [path, setPath] = useState<string | null>(null);

    useEffect(() => {
        getSimpleIcons().then(data => {
            const output = data.find(i => i.slug === slug);
            if (output) setPath(output.path);
        }).catch(err => console.error(err));
    }, [slug]);

    if (!path) return <span className={className}>...</span>;

    return (
        <svg viewBox="0 0 24 24" className={className} fill="currentColor">
            <path d={path} />
        </svg>
    );
}

interface IconPickerProps {
    currentIcon: string | null;
    onSelect: (icon: string) => void;
    children: React.ReactNode;
    open?: boolean;
    onOpenChange?: (open: boolean) => void;
}

export const IconPicker = ({ currentIcon, onSelect, children, open: controlledOpen, onOpenChange }: IconPickerProps) => {
    const [internalOpen, setInternalOpen] = useState(false);
    const isControlled = controlledOpen !== undefined;
    const open = isControlled ? controlledOpen : internalOpen;
    const setOpen = isControlled ? onOpenChange! : setInternalOpen;

    const [mode, setMode] = useState<'picker' | 'url'>('picker');
    const [url, setUrl] = useState('');
    const [search, setSearch] = useState('');

    const lucideList = useMemo(() => {
        return Object.keys(icons)
            .map(key => ({
                name: key,
                Icon: (icons as any)[key] as React.ComponentType<{ className?: string }>
            }));
    }, []);

    const filteredLucideList = useMemo(() => {
        if (!search) return lucideList; // Afficher tous les ic√¥nes sans recherche

        const searchLower = search.toLowerCase();
        const results = lucideList.filter(({ name }) => {
            const nameLower = name.toLowerCase();
            // Priorit√© : commence par la recherche
            return nameLower.includes(searchLower);
        });

        // Trier : ceux qui commencent par la recherche en premier
        results.sort((a, b) => {
            const aStarts = a.name.toLowerCase().startsWith(searchLower);
            const bStarts = b.name.toLowerCase().startsWith(searchLower);
            if (aStarts && !bStarts) return -1;
            if (!aStarts && bStarts) return 1;
            return a.name.localeCompare(b.name);
        });

        return results; // Retourner tous les r√©sultats filtr√©s
    }, [lucideList, search]);

    const filteredEmojiCategories = useMemo((): Record<string, EmojiCategory> => {
        if (!search) return EMOJI_CATEGORIES;
        // Si recherche active, ne pas afficher les emojis (ils n'ont pas de nom)
        return {};
    }, [search]);

    const handleSelect = (value: string) => {
        onSelect(value);
        setOpen(false);
    };

    const handleUrlSubmit = () => {
        if (url) {
            onSelect(url);
            setOpen(false);
        }
    };

    return (
        <Popover open={open} onOpenChange={setOpen} modal={true}>
            <PopoverTrigger asChild>
                {children}
            </PopoverTrigger>
            <PopoverContent className="p-2 w-[320px] z-[99999]" align="start">
                {mode === 'picker' ? (
                    <Command shouldFilter={false}>
                        <CommandInput
                            placeholder={t('icon_picker.search_placeholder')}
                            value={search}
                            onValueChange={setSearch}
                        />
                        <CommandList className="max-h-[300px]">
                            <CommandEmpty>No results found.</CommandEmpty>

                            {Object.entries(filteredEmojiCategories).map(([key, category]) => (
                                <CommandGroup key={key} heading={category.name}>
                                    <div className="flex flex-wrap gap-1 p-2">
                                        {category.emojis.map((emoji) => (
                                            <CommandItem
                                                key={emoji}
                                                value={"emoji " + emoji}
                                                onSelect={() => handleSelect('emoji:' + emoji)}
                                                className="flex items-center justify-center w-8 h-8 cursor-pointer rounded hover:bg-muted"
                                                title={emoji}
                                            >
                                                <span className="text-lg">{emoji}</span>
                                            </CommandItem>
                                        ))}
                                    </div>
                                </CommandGroup>
                            ))}

                            {filteredLucideList.length > 0 && (
                                <CommandGroup heading="Icons">
                                    <div className="flex flex-wrap gap-1 p-2">
                                        {filteredLucideList.map(({ name, Icon }) => (
                                            <CommandItem
                                                key={name}
                                                value={name}
                                                onSelect={() => handleSelect('lucide:' + name)}
                                                className="flex items-center justify-center w-8 h-8 cursor-pointer rounded hover:bg-muted"
                                                title={name}
                                            >
                                                <Icon className="h-4 w-4" />
                                            </CommandItem>
                                        ))}
                                    </div>
                                </CommandGroup>
                            )}
                        </CommandList>
                        <div className="p-2 border-t">
                            <button
                                className="text-xs text-blue-500 hover:underline w-full text-center"
                                onClick={() => setMode('url')}
                            >
                                {t('icon_picker.enter_url')}
                            </button>
                        </div>
                    </Command>
                ) : (
                    <div className="p-4 space-y-2">
                        <h4 className="font-medium text-sm">{t('icon_picker.enter_url')}</h4>
                        <Input
                            placeholder={t('icon_picker.url_placeholder')}
                            value={url}
                            onChange={(e) => setUrl(e.target.value)}
                            onKeyDown={(e) => { if (e.key === 'Enter') handleUrlSubmit(); }}
                            autoFocus
                        />
                        <div className="flex gap-2 justify-end">
                            <Button variant="ghost" size="sm" onClick={() => setMode('picker')}>
                                {t('collection.cancel')}
                            </Button>
                            <Button size="sm" onClick={handleUrlSubmit}>
                                OK
                            </Button>
                        </div>
                    </div>
                )}
            </PopoverContent>
        </Popover>
    );
};
